<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BorderHealth Guardian v1.4.4</title>
<link rel="manifest" href="manifest.webmanifest"/>
<meta name="theme-color" content="#4f46e5"/>
<link rel="icon" href="icons/icon-192.png"/>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .btn{padding:.6rem .9rem;border-radius:.75rem;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .card{background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .input{border:1px solid #e5e7eb;border-radius:.75rem;padding:.6rem .8rem}
  .badge{display:inline-block;padding:.2rem .5rem;border-radius:.5rem;font-size:.75rem}
  .badge-green{background:#dcfce7;color:#166534}
  .badge-amber{background:#fef3c7;color:#92400e}
  .badge-red{background:#fee2e2;color:#991b1b}
  .table{width:100%;border-collapse:separate;border-spacing:0 .5rem}
  .table th{font-size:.8rem;text-transform:uppercase;color:#6b7280;text-align:left;padding:.25rem .5rem}
  .row{background:#fff;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .row td{padding:.6rem .7rem}
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
<header class="bg-indigo-600 text-white p-4 shadow">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div>
      <div class="font-bold text-xl">BorderHealth Guardian <span class="text-xs opacity-80">v1.4.4</span></div>
      <div class="text-xs text-indigo-200">PWA ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ ‡∏Å‡∏•‡πâ‡∏≠‡∏á + OCR MRZ ‚Ä¢ ‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á/‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</div>
    </div>
    <div class="flex gap-2">
      <button id="assetCheck" class="px-3 py-2 bg-indigo-700 rounded">‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ü‡∏•‡πå OCR</button>
    </div>
  </div>
</header>

<nav class="max-w-6xl mx-auto mt-3 flex flex-wrap gap-2">
  <button class="tab btn bg-white" data-tab="home">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
  <button class="tab btn bg-white" data-tab="ocr">OCR MRZ</button>
  <button class="tab btn bg-white" data-tab="quick">‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</button>
  <button class="tab btn bg-white" data-tab="disease">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</button>
  <button class="tab btn bg-white" data-tab="stats">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
</nav>

<main class="max-w-6xl mx-auto p-4 space-y-4">
  <!-- HOME -->
  <section id="tab-home" class="space-y-4">
    <div class="grid md:grid-cols-4 sm:grid-cols-2 gap-3">
      <a class="btn bg-indigo-600 text-white text-center" data-tabto="ocr">üîç ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</a>
      <a class="btn bg-white border text-center" data-tabto="quick">üë§ ‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</a>
      <a class="btn bg-white border text-center" data-tabto="disease">üîî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
      <a class="btn bg-white border text-center" data-tabto="stats">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div class="card"><div class="text-3xl font-bold" id="dash-today">0</div><div class="text-sm text-gray-500">‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
      <div class="card"><div class="text-3xl font-bold text-amber-600" id="dash-risk">0</div><div class="text-sm text-gray-500">‡∏ï‡∏¥‡∏î‡∏ò‡∏á</div></div>
      <div class="card"><div class="text-3xl font-bold text-green-600" id="dash-clear">0</div><div class="text-sm text-gray-500">‡∏ú‡πà‡∏≤‡∏ô</div></div>
    </div>
  </section>

  <!-- OCR -->
  <section id="tab-ocr" class="hidden">
    <div class="card space-y-3">
      <h3 class="font-bold">‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏Å‡∏•‡πâ‡∏≠‡∏á + OCR MRZ)</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <video id="cam" class="w-full rounded-xl bg-black aspect-video" autoplay playsinline></video>
          <div class="grid grid-cols-3 gap-2">
            <button class="btn bg-indigo-600 text-white" id="openCam">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button class="btn bg-white border" id="takePhoto">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
            <button class="btn bg-white border" id="closeCam">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <input type="file" id="fileInput" accept="image/*" class="hidden"/>
            <button class="btn bg-white border" id="pickFile">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            <select id="ocrMode" class="border rounded-lg px-2"><option value="cdn">CDN</option><option value="local">Local assets</option></select>
            <button class="btn bg-yellow-500 text-white col-span-1" id="btnRunMrz">OCR MRZ</button>
          </div>
        </div>
        <div class="space-y-2">
          <div class="border-4 border-dashed border-indigo-300 rounded-xl h-48 flex items-center justify-center text-indigo-600" id="scan-frame">
            <div class="text-center"><div class="text-2xl">üì∑</div><div>‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î MRZ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</div></div>
          </div>
          <img id="photo" class="hidden w-full rounded-xl border" alt="captured"/>
        </div>
      </div>

      <div class="grid md:grid-cols-5 gap-2 text-sm">
        <div class="card"><div class="text-gray-500">Passport</div><div id="scan-passport">-</div></div>
        <div class="card"><div class="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠</div><div id="scan-firstName">-</div></div>
        <div class="card"><div class="text-gray-500">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div><div id="scan-lastName">-</div></div>
        <div class="card"><div class="text-gray-500">‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</div><div id="scan-nationality">-</div></div>
        <div class="card"><div class="text-gray-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</div><div id="scan-birthDate">-</div></div>
      </div>

      <div><button class="btn bg-white border text-xs" id="toggleDbg">‡πÅ‡∏™‡∏î‡∏á/OCR Debug</button></div>
      <pre id="ocrDbg" class="hidden mt-2 p-2 bg-gray-50 rounded text-[10px] whitespace-pre-wrap"></pre>
    </div>
  </section>

  <!-- QUICK SCREEN -->
  <section id="tab-quick" class="hidden">
    <div class="card space-y-3">
      <h3 class="font-bold">‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <input id="qs-name" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input id="qs-passport" class="input" placeholder="‡πÄ‡∏•‡∏Ç‡∏û‡∏≤‡∏™‡∏õ‡∏≠‡∏£‡πå‡∏ï">
        <input id="qs-country" class="input" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô CN/JP/TH">
        <select id="qs-symptom" class="input">
          <option value="">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
          <option>‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á</option><option>‡πÑ‡∏≠/‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠</option><option>‡∏ú‡∏∑‡πà‡∏ô</option><option>‡∏õ‡∏ß‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢</option>
        </select>
        <select id="qs-contact" class="input">
          <option value="">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</option>
          <option>‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</option><option>‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏∞‡∏ö‡∏≤‡∏î</option><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="qs-calc" class="btn bg-indigo-600 text-white">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="qs-clear" class="btn bg-white border">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        <button id="qs-export" class="btn bg-white border">Export CSV</button>
      </div>
      <div id="qs-result" class="text-sm text-gray-700"></div>

      <div class="mt-3">
        <table class="table">
          <thead><tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏û‡∏≤‡∏™‡∏õ‡∏≠‡∏£‡πå‡∏ï</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th><th>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
          </tr></thead>
          <tbody id="qs-table"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DISEASE MANAGER -->
  <section id="tab-disease" class="hidden">
    <div class="card space-y-3">
      <h3 class="font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
      <div class="grid md:grid-cols-4 gap-2">
        <input id="dz-name" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô Influenza A)">
        <select id="dz-level" class="input">
          <option value="low">‡∏ï‡πà‡∏≥</option><option value="medium">‡∏Å‡∏•‡∏≤‡∏á</option><option value="high">‡∏™‡∏π‡∏á</option>
        </select>
        <input id="dz-countries" class="input" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏∞‡∏ö‡∏≤‡∏î (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)">
        <button id="dz-add" class="btn bg-indigo-600 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ</button>
      </div>
      <div class="mt-3">
        <table class="table">
          <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</th><th>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="dz-table"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="tab-stats" class="hidden">
    <div class="card space-y-2">
      <h3 class="font-bold">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
      <div class="grid md:grid-cols-3 gap-3">
        <div class="card"><div class="text-3xl font-bold" id="st-total">0</div><div class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="card"><div class="text-3xl font-bold text-amber-600" id="st-risk">0</div><div class="text-sm text-gray-500">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div></div>
        <div class="card"><div class="text-3xl font-bold text-green-600" id="st-clear">0</div><div class="text-sm text-gray-500">‡∏ú‡πà‡∏≤‡∏ô</div></div>
      </div>
      <p class="text-xs text-gray-500">* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô ‚Äú‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô‚Äù</p>
    </div>
  </section>
</main>

<script>
// ====== Basic Tabs ======
function showTab(id){
  for(const el of document.querySelectorAll('main > section')) el.classList.add('hidden');
  const t=document.getElementById('tab-'+id); if(t) t.classList.remove('hidden');
  for(const b of document.querySelectorAll('nav .tab')) b.classList.remove('bg-indigo-600','text-white');
  const btn=[...document.querySelectorAll('nav .tab')].find(x=>x.dataset.tab===id);
  if(btn) btn.classList.add('bg-indigo-600','text-white');
}
document.addEventListener('click',e=>{
  const to=e.target.closest('[data-tab]'); if(to) showTab(to.dataset.tab);
  const to2=e.target.closest('[data-tabto]'); if(to2) showTab(to2.dataset.tabto);
});
showTab('home');

// ====== Storage Helpers ======
const DB={
  get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch{return def}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v))}
};
const KEY_QS='bhg.qs';   // screenings
const KEY_DZ='bhg.dz';   // diseases

// ====== Dashboard ======
function refreshDashboard(){
  const list=DB.get(KEY_QS,[]);
  const today=new Date().toISOString().slice(0,10);
  const todayList=list.filter(x=>x.date?.startsWith(today));
  const risk=list.filter(x=>x.risk!=='‡∏ú‡πà‡∏≤‡∏ô');
  const clear=list.filter(x=>x.risk==='‡∏ú‡πà‡∏≤‡∏ô');
  document.getElementById('dash-today').textContent=todayList.length;
  document.getElementById('dash-risk').textContent=risk.length;
  document.getElementById('dash-clear').textContent=clear.length;
}
refreshDashboard();

// ====== OCR Asset Check ======
async function checkAsset(url){ try{ const r=await fetch(url,{cache:'no-cache'}); return r.ok }catch(e){ return false } }
document.getElementById('assetCheck').onclick=async()=>{
  const dbg=document.getElementById('ocrDbg'); if(dbg) dbg.classList.remove('hidden');
  const a0=await checkAsset('./assets/tesseract/tesseract.min.js');
  const a =await checkAsset('./assets/tesseract/worker.min.js');
  const b =await checkAsset('./assets/tesseract/tesseract-core.wasm.js');
  const c =await checkAsset('./assets/tessdata/eng.traineddata');
  (dbg||document.body).insertAdjacentHTML('beforeend','<pre id=\"ocrDbg\" class=\"mt-2 p-2 bg-gray-50 rounded text-[10px] whitespace-pre-wrap\"></pre>');
  document.getElementById('ocrDbg').textContent=[
    'assets/tesseract/tesseract.min.js ...... ' + (a0?'‡∏û‡∏ö ‚úÖ':'‡πÑ‡∏°‡πà‡∏û‡∏ö ‚ùå'),
    'assets/tesseract/worker.min.js ......... ' + (a ?'‡∏û‡∏ö ‚úÖ':'‡πÑ‡∏°‡πà‡∏û‡∏ö ‚ùå'),
    'assets/tesseract/tesseract-core.wasm.js  ' + (b ?'‡∏û‡∏ö ‚úÖ':'‡πÑ‡∏°‡πà‡∏û‡∏ö ‚ùå'),
    'assets/tessdata/eng.traineddata ........ ' + (c ?'‡∏û‡∏ö ‚úÖ':'‡πÑ‡∏°‡πà‡∏û‡∏ö ‚ùå')
  ].join('\\n');
};

// ====== Camera Controls ======
async function startCamera(){ try{ const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false}); document.getElementById('cam').srcObject=s; window._cam=s; }catch(e){ alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+(e.message||e)); } }
function stopCamera(){ if(window._cam){ window._cam.getTracks().forEach(t=>t.stop()); window._cam=null; } document.getElementById('cam').srcObject=null; }
function capturePhoto(){ const v=document.getElementById('cam'); if(!v||!v.srcObject){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'); return; } const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0,c.width,c.height); const url=c.toDataURL('image/jpeg',0.9); const img=document.getElementById('photo'); img.src=url; img.classList.remove('hidden'); document.getElementById('scan-frame').classList.add('hidden'); }
document.getElementById('openCam')?.addEventListener('click',startCamera);
document.getElementById('closeCam')?.addEventListener('click',stopCamera);
document.getElementById('takePhoto')?.addEventListener('click',capturePhoto);
document.getElementById('pickFile')?.addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput')?.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const img=document.getElementById('photo'); img.src=r.result; img.classList.remove('hidden'); document.getElementById('scan-frame').classList.add('hidden'); }; r.readAsDataURL(f); });

// ====== Tesseract Loader ======
function loadScript(src){ return new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+src)); document.head.appendChild(s); }); }
function loadTesseractCDN(){ if(window.Tesseract) return Promise.resolve(); return loadScript('https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js'); }
async function ensureTesseract(mode){ if(window.Tesseract) return; if(mode==='local'){ await loadScript('./assets/tesseract/tesseract.min.js'); } else { await loadTesseractCDN(); } }

function parseMRZ(text){ const lines=text.toUpperCase().replace(/[^A-Z0-9<\n]/g,'').split(/\n/).map(x=>x.trim()).filter(Boolean); if(lines.length<2) return null; const l1=lines[0].padEnd(44,'<'), l2=lines[1].padEnd(44,'<'); const nationality=l1.slice(2,5).replace(/</g,''); const namePart=l1.slice(5).replace(/<+/g,' ').trim(); const parts=namePart.split(' ').filter(Boolean); const last=parts[0]||'', first=parts.slice(1).join(' ')||''; const passport=l2.slice(0,9).replace(/</g,''), birth=l2.slice(13,19); const toDate=(yymmdd)=>{ const yy=+yymmdd.slice(0,2), mm=+yymmdd.slice(2,4), dd=+yymmdd.slice(4,6); const yyyy=yy>=50?1900+yy:2000+yy; return `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`; }; return {passportNo:passport, firstName:first, lastName:last, nationality, birthDate:toDate(birth)}; }

async function runMRZ(){ const img=document.getElementById('photo'); if(img.classList.contains('hidden')){ alert('‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô'); return; } const modeSel=document.getElementById('ocrMode'); let mode=modeSel.value; const btn=document.getElementById('btnRunMrz'); const old=btn.textContent; btn.disabled=true; btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô...'; document.body.style.cursor='progress'; try{ try{ await ensureTesseract(mode); }catch(e){ if(mode==='local'){ mode='cdn'; modeSel.value='cdn'; await ensureTesseract('cdn'); } else { throw e; } } let workerConfig; if(mode==='local'){ workerConfig={ workerPath:'./assets/tesseract/worker.min.js', corePath:'./assets/tesseract/tesseract-core.wasm.js', langPath:'./assets/tessdata/', logger:m=>console.log(m) }; }else{ const CDN_JS='https://unpkg.com/tesseract.js@5.1.1/dist/'; const CDN_CORE='https://unpkg.com/tesseract.js-core@5.1.1/tesseract-core.wasm.js'; workerConfig={ workerPath:CDN_JS+'worker.min.js', corePath:CDN_CORE, langPath:'./assets/tessdata/', logger:m=>console.log(m) }; } const worker=await Tesseract.createWorker(workerConfig); await worker.loadLanguage('eng'); await worker.initialize('eng'); await worker.setParameters({tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',preserve_interword_spaces:'1',tessedit_pageseg_mode:'6',user_defined_dpi:'300'}); const ret=await worker.recognize(img); await worker.terminate(); const text=ret?.data?.text||''; document.getElementById('ocrDbg')?.classList.remove('hidden'); (document.getElementById('ocrDbg')||document.body).textContent=text; const mrz=parseMRZ(text); if(!mrz){ alert('‡∏≠‡πà‡∏≤‡∏ô MRZ ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; } document.getElementById('scan-passport').textContent=mrz.passportNo||'-'; document.getElementById('scan-firstName').textContent=mrz.firstName||'-'; document.getElementById('scan-lastName').textContent=mrz.lastName||'-'; document.getElementById('scan-nationality').textContent=mrz.nationality||'-'; document.getElementById('scan-birthDate').textContent=mrz.birthDate||'-'; }catch(e){ alert('OCR ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(e?.message||e)); } finally{ btn.disabled=false; btn.textContent=old; document.body.style.cursor='default'; } }
document.getElementById('btnRunMrz')?.addEventListener('click',runMRZ);
document.getElementById('toggleDbg')?.addEventListener('click',()=>document.getElementById('ocrDbg').classList.toggle('hidden'));

// ====== Quick Screen Logic ======
function riskScore({symptom, contact}){
  let score=0;
  if(symptom && symptom!=='') score++;
  if(contact && contact!=='‡πÑ‡∏°‡πà‡∏°‡∏µ') score++;
  return score>=2 ? '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á' : (score===1 ? '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á' : '‡∏ú‡πà‡∏≤‡∏ô');
}
function renderQS(){
  const list=DB.get(KEY_QS,[]);
  const tb=document.getElementById('qs-table'); tb.innerHTML='';
  for(const it of list.slice().reverse()){
    const tr=document.createElement('tr'); tr.className='row';
    const badge=it.risk==='‡∏ú‡πà‡∏≤‡∏ô'?'badge badge-green':(it.risk==='‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á'?'badge badge-amber':'badge badge-red');
    tr.innerHTML=`<td>${it.date.replace('T',' ').slice(0,16)}</td>
      <td>${it.name||'-'}</td><td>${it.passport||'-'}</td><td>${it.country||'-'}</td>
      <td>${it.symptom||'-'}</td><td><span class="${badge}">${it.risk}</span></td>`;
    tb.appendChild(tr);
  }
  // refresh stats & dashboard
  const total=list.length, risk=list.filter(x=>x.risk!=='‡∏ú‡πà‡∏≤‡∏ô').length, clear=list.filter(x=>x.risk==='‡∏ú‡πà‡∏≤‡∏ô').length;
  document.getElementById('st-total').textContent=total;
  document.getElementById('st-risk').textContent=risk;
  document.getElementById('st-clear').textContent=clear;
  refreshDashboard();
}
renderQS();

document.getElementById('qs-calc')?.addEventListener('click',()=>{
  const rec={
    name:document.getElementById('qs-name').value.trim(),
    passport:document.getElementById('qs-passport').value.trim(),
    country:document.getElementById('qs-country').value.trim().toUpperCase(),
    symptom:document.getElementById('qs-symptom').value,
    contact:document.getElementById('qs-contact').value,
    date:new Date().toISOString()
  };
  rec.risk=riskScore(rec);
  const list=DB.get(KEY_QS,[]); list.push(rec); DB.set(KEY_QS,list);
  document.getElementById('qs-result').innerHTML=`‡∏ú‡∏•‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á: <b>${rec.risk}</b>`;
  renderQS();
});

document.getElementById('qs-clear')?.addEventListener('click',()=>{
  for(const id of ['qs-name','qs-passport','qs-country','qs-symptom','qs-contact']) document.getElementById(id).value='';
  document.getElementById('qs-result').textContent='';
});

document.getElementById('qs-export')?.addEventListener('click',()=>{
  const list=DB.get(KEY_QS,[]);
  const header=['date','name','passport','country','symptom','contact','risk'];
  const rows=[header.join(',')].concat(list.map(x=>header.map(k=>`"${(x[k]??'').toString().replace(/"/g,'""')}"`).join(',')));
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='screenings.csv'; a.click();
});

// ====== Disease Manager ======
function renderDZ(){
  const list=DB.get(KEY_DZ,[]);
  const tb=document.getElementById('dz-table'); tb.innerHTML='';
  for(const [idx,it] of list.entries()){
    const tr=document.createElement('tr'); tr.className='row';
    const levelColor=it.level==='high'?'badge-red':(it.level==='medium'?'badge-amber':'badge-green');
    tr.innerHTML=`<td>${it.name}</td>
      <td><span class="badge ${levelColor}">${it.level}</span></td>
      <td>${(it.countries||[]).join(', ')||'-'}</td>
      <td><label class="inline-flex items-center gap-2"><input type="checkbox" ${it.alert?'checked':''} data-act="toggle" data-idx="${idx}"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label></td>
      <td class="text-right space-x-1">
        <button class="btn bg-white border text-xs" data-act="edit" data-idx="${idx}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn bg-white border text-xs" data-act="del" data-idx="${idx}">‡∏•‡∏ö</button>
      </td>`;
    tb.appendChild(tr);
  }
}
renderDZ();

document.getElementById('dz-add')?.addEventListener('click',()=>{
  const name=document.getElementById('dz-name').value.trim();
  const level=document.getElementById('dz-level').value;
  const countries=document.getElementById('dz-countries').value.split(',').map(x=>x.trim()).filter(Boolean);
  if(!name){ alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ'); return; }
  const list=DB.get(KEY_DZ,[]); list.push({name,level,countries,alert:true}); DB.set(KEY_DZ,list);
  for(const id of ['dz-name','dz-countries']) document.getElementById(id).value='';
  renderDZ();
});

document.getElementById('dz-table')?.addEventListener('click',e=>{
  const act=e.target.dataset.act; if(!act) return;
  const idx=+e.target.dataset.idx; const list=DB.get(KEY_DZ,[]);
  if(act==='del'){ if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')){ list.splice(idx,1); DB.set(KEY_DZ,list); renderDZ(); } }
  if(act==='edit'){
    const it=list[idx];
    const name=prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ',it.name)||it.name;
    const level=prompt('‡∏£‡∏∞‡∏î‡∏±‡∏ö (low/medium/high)',it.level)||it.level;
    const countries=(prompt('‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,', (it.countries||[]).join(', '))||'').split(',').map(x=>x.trim()).filter(Boolean);
    list[idx]={...it,name,level,countries}; DB.set(KEY_DZ,list); renderDZ();
  }
});

document.getElementById('dz-table')?.addEventListener('change',e=>{
  if(e.target.dataset.act==='toggle'){
    const idx=+e.target.dataset.idx; const list=DB.get(KEY_DZ,[]); list[idx].alert=e.target.checked; DB.set(KEY_DZ,list);
  }
});

// ====== SW Register ======
if('serviceWorker' in navigator && (location.protocol==='http:'||location.protocol==='https:')){
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
